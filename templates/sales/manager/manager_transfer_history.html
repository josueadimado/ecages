{% extends "layouts/base_sales.html" %}
{% block title %}Historique des transferts | ECAGES{% endblock %}
{% block extra_css %}
<style>
  :root{ --ring:#e5e7eb; --muted:#64748b; }
  .page{ padding:16px; }
  .ribbon{ background:linear-gradient(180deg,#6e0a0a,var(--brand)); color:#fff; border-radius:18px; padding:18px 24px; font-weight:900; margin-bottom:12px; overflow:hidden; }
  .marquee{ position:relative; width:100%; overflow:hidden; }
  .marquee span{ display:inline-block; padding-left:100%; white-space:nowrap; animation: scrollLeft 18s linear infinite; font-size:1.35rem; }
  @keyframes scrollLeft { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
  .card{ background:#fff; border:1px solid var(--ring); border-radius:12px; box-shadow:0 8px 24px rgba(2,8,23,.06); }
  .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:12px 16px; }
  .filters input, .filters select{ border:1px solid var(--ring); border-radius:10px; padding:.5rem .7rem; background:#fff; }
  .btn{ border:1px solid var(--ring); background:#fff; border-radius:10px; padding:.45rem .75rem; font-weight:800; }
  table.table{width:100%; border-collapse:separate; border-spacing:0; min-width:900px;}
  table.table th{position:sticky; top:0; background:#fafafa; text-align:left; font-size:.85rem; color:var(--muted); border-bottom:1px solid var(--ring); padding:.7rem .9rem; font-weight:900;}
  table.table td{border-bottom:1px solid #f2f4f7; padding:.75rem .9rem;}
</style>
{% endblock %}
{% block content %}
<div class="page">
  <div class="ribbon"><div class="marquee"><span id="ribbonText">ECAGES</span></div></div>
  <div class="card" style="margin-bottom:12px;">
    <form class="filters" method="get">
      <label>Type
        <select name="kind">
          <option value="" {% if not kind %}selected{% endif %}>Tous</option>
          <option value="in" {% if kind == 'in' %}selected{% endif %}>Entrants</option>
          <option value="out" {% if kind == 'out' %}selected{% endif %}>Sortants</option>
        </select>
      </label>
      <label>Du <input type="date" name="start" value="{{ start }}" /></label>
      <label>Au <input type="date" name="end" value="{{ end }}" /></label>
      <input name="q" placeholder="N° transfert ou point de vente" value="{{ q }}" />
      <button class="btn">Filtrer</button>
    </form>
  </div>
  <div class="card" style="overflow:auto;">
    <table class="table">
      <thead><tr><th>Date</th><th>N° Transfert</th><th>Type</th><th>De</th><th>Vers</th><th class="right">Action</th></tr></thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td>{% if r.number %}{{ r.number }}{% else %}TR-{{ r.id }}{% endif %}</td>
          <td>{% if r.to_salespoint_id == salespoint.id %}<span style="color:#047857;font-weight:800">Entrant</span>{% else %}<span style="color:#b45309;font-weight:800">Sortant</span>{% endif %}</td>
          <td>{{ r.from_salespoint.name }}</td>
          <td>{{ r.to_salespoint.name }}</td>
          <td class="right"><button class="btn" data-view="{{ r.id }}">Voir</button></td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="color:#64748b; padding:1rem .9rem; font-weight:700;">Aucun transfert.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Simple read-only modal -->
  <div id="thModal" class="modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:60">
    <div class="sheet" style="width:min(760px,95vw); background:#fff; border:1px solid var(--ring); border-radius:16px; box-shadow:0 20px 60px rgba(2,8,23,.2); overflow:hidden">
      <div class="hd" style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--ring); font-weight:900">Transfert <span id="thNo"></span><button id="thClose" class="btn">✕</button></div>
      <div class="bd" id="thBody" style="padding:16px"></div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  const el=document.getElementById('ribbonText'); if(el){ function pad(n){return n<10?'0'+n:n;} function cap(s){return s? s.charAt(0).toUpperCase()+s.slice(1):s;} function tick(){ const d=new Date(); const dateStr=cap(d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})); const timeStr=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; el.textContent=`ECAGES • {{ salespoint.name|default:"—" }} • ${dateStr} — ${timeStr}`; } tick(); setInterval(tick,1000); }
  const $=s=>document.querySelector(s);
  const modal=$('#thModal'), body=$('#thBody'), no=$('#thNo');
  function open(){ modal.style.display='flex'; }
  function close(){ modal.style.display='none'; }
  $('#thClose')?.addEventListener('click', close);
  async function view(id){ try{ const r=await fetch(`/sales/api/manager/transfer-request/${id}/lines/`); const res=await r.json(); if(!res.ok){ alert(res.error||'Erreur'); return; } no.textContent = res.number||`TR-${res.id}`; const rows=(res.lines||[]).map(li=>`<tr><td><strong>${li.name}</strong></td><td>${li.brand||''}</td><td style='font-weight:800'>${li.qty}</td></tr>`).join(''); body.innerHTML = `<div style='max-height:360px; overflow:auto;'><table class='table'><thead><tr><th>Produit</th><th>Marque</th><th>Qté approuvée</th></tr></thead><tbody>${rows||'<tr><td colspan=3>Aucune ligne.</td></tr>'}</tbody></table></div>`; open(); }catch(e){ alert('Erreur réseau'); } }
  document.querySelectorAll('[data-view]').forEach(b=>b.addEventListener('click',()=>view(b.dataset.view)));
})();
</script>
{% endblock %}


