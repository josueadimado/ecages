{% extends "layouts/base_sales.html" %}
{% block title %}Transferts entrants | ECAGES{% endblock %}
{% block extra_css %}
  <style>
    :root{ --ring:#e5e7eb; --muted:#64748b; --ink:#0f172a; --bg:#f8fafc; --chip:#eef2ff; --chip-text:#3730a3; }
    .page{ padding:16px; }
    .ribbon{ background:linear-gradient(180deg,#6e0a0a,var(--brand)); color:#fff; border-radius:18px; padding:18px 24px; font-weight:900; margin-bottom:12px; overflow:hidden; }
    .marquee{ position:relative; width:100%; overflow:hidden; }
    .marquee span{ display:inline-block; padding-left:100%; white-space:nowrap; animation: scrollLeft 18s linear infinite; font-size:1.35rem; }
    @keyframes scrollLeft { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
    .card{ background:#fff; border:1px solid var(--ring); border-radius:12px; box-shadow:0 8px 24px rgba(2,8,23,.06); }
    table.table{width:100%; border-collapse:separate; border-spacing:0; font-size:.98rem; min-width:880px;}
    table.table th{position:sticky; top:0; background:#fafafa; text-align:left; font-size:.85rem; color:#muted; border-bottom:1px solid var(--ring); padding:.7rem .9rem; font-weight:900;}
    table.table td{border-bottom:1px solid #f2f4f7; padding:.75rem .9rem;}
    .badge{display:inline-block; padding:.22rem .55rem; border-radius:999px; font-weight:800; font-size:.78rem; border:1px solid var(--ring);}
    .b-sent{background:#fffbeb; color:#92400e}
    .b-partial{background:#eff6ff; color:#1e3a8a}
    .b-val{background:#ecfdf5; color:#047857}
    /* Modal styles */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,8,23,.45); z-index:60; backdrop-filter:saturate(120%) blur(2px)}
    .modal.show{display:flex}
    .sheet{width:min(820px,95vw); background:linear-gradient(180deg,#ffffff,#fdfdfd); border:1px solid var(--ring); border-radius:18px; box-shadow:0 30px 80px rgba(2,8,23,.25); overflow:hidden}
    .sheet .hd{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--ring); font-weight:900; color:var(--ink)}
    .sheet .bd{padding:16px; background:#fff}
    .actions{display:flex; justify-content:flex-end; gap:.6rem; padding:12px 16px; border-top:1px solid var(--ring); background:#fafafa}
    .chip{display:inline-flex; align-items:center; gap:.4rem; background:var(--chip); color:var(--chip-text); border:1px solid #e0e7ff; padding:.28rem .6rem; border-radius:999px; font-weight:800; font-size:.78rem}
    .toolbar{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
    .btn-sm{padding:.45rem .7rem; border-radius:10px; border:1px solid var(--ring); background:#fff; font-weight:700; color:#1f2937}
    .btn-sm:hover{background:#f8fafc}
    .count{margin-left:auto; color:#475569; font-weight:800}
    .list{width:100%; border-collapse:separate; border-spacing:0}
    .list thead th{font-size:.78rem; color:#64748b; text-transform:uppercase; background:#fafafa; padding:.6rem .75rem; border-bottom:1px solid var(--ring)}
    .list tbody td{padding:.7rem .75rem; border-bottom:1px solid #f2f4f7}
    .list tbody tr:nth-child(odd){background:#fcfcfd}
    .right{text-align:right}
    /* Nicer validate button */
    #inbDo{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border:none; border-radius:12px; color:#fff; font-weight:900; letter-spacing:.2px; background:linear-gradient(135deg,#16a34a,#22c55e); box-shadow:0 6px 16px rgba(34,197,94,.35); transition:transform .08s ease, box-shadow .2s ease, filter .2s ease; }
    #inbDo:hover{ filter:saturate(115%); box-shadow:0 8px 20px rgba(34,197,94,.45); }
    #inbDo:active{ transform:translateY(1px); }
    #inbDo[disabled]{ opacity:.5; box-shadow:none; cursor:not-allowed; }
    #inbDo svg{ width:16px; height:16px; }
  </style>
{% endblock %}
{% block content %}
<div class="page">
  <div class="ribbon"><div class="marquee"><span id="ribbonText">ECAGES</span></div></div>
  <div class="card" style="overflow:auto; padding:8px 12px;">
    <table class="table">
      <thead>
        <tr>
          <th>Référence</th>
          <th>Date</th>
          <th>De</th>
          <th>Produits</th>
          <th>Qté envoyée</th>
          <th>Statut</th>
          <th class="right">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{% if r.reference %}{{ r.reference }}{% else %}#{{ r.id }}{% endif %}</td>
          <td>{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td>Entrepôt</td>
          <td>{{ r.lines.count }}</td>
          <td>{{ r.total_quantity }}</td>
          <td>
            {% if r.status == 'sent' %}<span class="badge b-sent">Envoyée</span>
            {% elif r.status == 'partially_validated' %}<span class="badge b-partial">Partielle</span>
            {% elif r.status == 'validated' %}<span class="badge b-val">Validée</span>
            {% else %}<span class="badge">{{ r.get_status_display }}</span>
            {% endif %}
          </td>
          <td class="right">
            <button class="btn" data-view="{{ r.id }}">Voir</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" style="color:#64748b; padding:1rem .9rem; font-weight:700;">Aucun approvisionnement entrant.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal validate selected lines -->
  <div id="inbModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <div class="hd">Réception d'approvisionnement <span id="inbNo" class="chip"></span><button id="inbClose" class="btn btn-sm">✕</button></div>
      <div class="bd" id="inbBody"></div>
      <div class="actions"><span id="inbCount" class="count">0 sélection</span><button id="inbDo" disabled><svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.5 7.5a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L8.5 11.586l6.793-6.793a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Valider la sélection</button></div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  var el=document.getElementById('ribbonText');
  function pad(n){return n<10?'0'+n:n;}
  function cap(s){return s? s.charAt(0).toUpperCase()+s.slice(1):s;}
  if(el){
    function tick(){
      var d=new Date();
      var dateStr=cap(d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}));
      var timeStr=pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds());
      el.textContent='ECAGES • {{ salespoint.name|default:"—" }} • '+dateStr+' — '+timeStr;
    }
    tick(); setInterval(tick,1000);
  }
})();
</script>
{% endblock %}