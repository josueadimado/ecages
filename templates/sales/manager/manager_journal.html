{% extends "layouts/base_sales.html" %}
{% block title %}Journal — Gérant | ECAGES{% endblock %}

{% block extra_css %}
  <style>
    :root { --ring:#e5e7eb; --muted:#64748b; }
    .page { padding: 16px; }
    .ribbon { background: linear-gradient(180deg, #6e0a0a, var(--brand)); color:#fff; border-radius:18px; padding:18px 24px; text-align:center; font-weight:900; letter-spacing:.3px; box-shadow: 0 8px 24px rgba(2, 8, 23, .06); border: 1px solid rgba(0,0,0,.05); overflow:hidden; margin-bottom: 12px; }
    .marquee { position: relative; width: 100%; overflow: hidden; }
    .marquee span { display:inline-block; padding-left:100%; white-space:nowrap; animation: scrollLeft 18s linear infinite; font-size: 1.35rem; }
    @keyframes scrollLeft { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .card { background:#fff; border:1px solid var(--ring); border-radius:12px; }
    .filters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:12px 16px; }
    .filters input, .filters select { border:1px solid var(--ring); border-radius:10px; padding:.5rem .7rem; font-weight:700; background:#f9fafb; }
    .filters .submit { background: var(--brand, #580706); color:#fff; border-color: var(--brand, #580706); }
    .wraptbl { background:#fff; border:1px solid var(--ring); border-radius:12px; overflow:auto; }
    table.table{width:100%; border-collapse:separate; border-spacing:0; font-size:.98rem; min-width:840px;}
    table.table th{position:sticky; top:0; background:#fafafa; text-align:left; font-size:.85rem; color:var(--muted); border-bottom:1px solid var(--ring); padding:.7rem .9rem; font-weight:900;}
    table.table td{border-bottom:1px solid #f2f4f7; padding:.75rem .9rem;}
    .badge{display:inline-block; padding:.22rem .55rem; border-radius:999px; font-weight:800; font-size:.78rem; border:1px solid var(--ring);}
    .b-await{background:#fff7ed; color:#b45309}
    .b-approved{background:#ecfdf5; color:#047857}
    .b-rejected{background:#fef2f2; color:#b91c1c}
    .b-cancelled{background:#eef2ff; color:#4338ca}
    .b-draft{background:#f3f4f6; color:#111827}
    .pager{display:flex; align-items:center; gap:8px; justify-content:flex-end; padding:10px 0;}
    .btn{ border:1px solid var(--ring); background:#fff; border-radius:10px; padding:.45rem .75rem; font-weight:800; cursor:pointer;}
    .btn.disabled{ opacity:.55; pointer-events:none; }
  </style>
{% endblock %}

{% block content %}
  {% now "Y-m-d" as today_str %}

  <div class="page">
    <div class="ribbon"><div class="marquee"><span id="ribbonText">ECAGES</span></div></div>
    <div class="card" style="margin-bottom:14px;">
      <form class="filters" method="get">
        <div class="title" style="margin-right:8px; font-weight:900;">Journal · {{ salespoint.name|default:"—" }}</div>
        <input type="text" name="q" value="{{ q }}" placeholder="Recherche (client, vendeur, numéro)…" />
        <select name="status">
          <option value="">Tous statuts</option>
          <option value="draft" {% if status == "draft" %}selected{% endif %}>Brouillon</option>
          <option value="awaiting_cashier" {% if status == "awaiting_cashier" %}selected{% endif %}>En attente de caisse</option>
          <option value="approved" {% if status == "approved" %}selected{% endif %}>Validée</option>
          <option value="rejected" {% if status == "rejected" %}selected{% endif %}>Rejetée</option>
          <option value="cancelled" {% if status == "cancelled" %}selected{% endif %}>Annulée</option>
        </select>
        <input type="date" name="from" value="{{ date_from|default:today_str }}">
        <input type="date" name="to" value="{{ date_to|default:today_str }}">
        <select name="per" title="Par page">
          <option value="25" {% if per == 25 %}selected{% endif %}>25 / page</option>
          <option value="50" {% if per == 50 %}selected{% endif %}>50 / page</option>
          <option value="100" {% if per == 100 %}selected{% endif %}>100 / page</option>
        </select>
        <button class="btn submit" type="submit">Appliquer</button>
        <div style="margin-left:auto; color:#64748b; font-weight:800;">Résultats: <strong>{{ totals.count|default:0 }}</strong></div>
      </form>
    </div>

    <div class="wraptbl">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Client</th>
            <th>Vendeur</th>
            <th>Montant</th>
            <th>Statut</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for s in rows %}
          <tr>
            <td><strong>{{ s.number }}</strong></td>
            <td>{{ s.customer_name }}</td>
            <td>{{ s.seller.get_full_name|default:s.seller.username }}</td>
            <td><strong>{{ s.total_amount|floatformat:0 }}</strong></td>
            <td>
              {% if s.status == 'draft' %}<span class="badge b-draft">Brouillon</span>
              {% elif s.status == 'awaiting_cashier' %}<span class="badge b-await">En attente</span>
              {% elif s.status == 'approved' %}<span class="badge b-approved">Validée</span>
              {% elif s.status == 'rejected' %}<span class="badge b-rejected">Rejetée</span>
              {% elif s.status == 'cancelled' %}<span class="badge b-cancelled">Annulée</span>
              {% else %}{{ s.status }}{% endif %}
            </td>
            <td>{{ s.created_at|date:"d/m/Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6" style="color:#64748b; padding:1rem .9rem; font-weight:700;">Aucune vente.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj and paginator %}
      <div class="pager">
        {% if page_obj.has_previous %}
          <a class="btn" href="?page=1{% if base_qs %}&{{ base_qs }}{% endif %}">« Première</a>
          <a class="btn" href="?page={{ page_obj.previous_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">‹ Précédente</a>
        {% else %}
          <span class="btn disabled">« Première</span>
          <span class="btn disabled">‹ Précédente</span>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="btn" href="?page={{ page_obj.next_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">Suivante ›</a>
          <a class="btn" href="?page={{ paginator.num_pages }}{% if base_qs %}&{{ base_qs }}{% endif %}">Dernière »</a>
        {% else %}
          <span class="btn disabled">Suivante ›</span>
          <span class="btn disabled">Dernière »</span>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const el = document.getElementById('ribbonText');
    if(!el) return;
    function pad(n){ return n<10?'0'+n:n; }
    function cap(s){ return s? s.charAt(0).toUpperCase()+s.slice(1):s; }
    function tick(){
      const d=new Date();
      const dateStr = cap(d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}));
      const timeStr = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      el.textContent = `ECAGES • ${'{{ salespoint.name|default:"—" }}'} • ${dateStr} — ${timeStr}`;
    }
    tick(); setInterval(tick, 1000);
  })();
</script>
{% endblock %}

