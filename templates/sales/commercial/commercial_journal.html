{% extends "layouts/base_sales.html" %}
{% block title %}Journal d'approvisionnement (Commercial){% endblock %}

{% block extra_css %}
<style>
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
  .filters { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
  .filters .field { display:flex; flex-direction:column; min-width:180px; }
  .filters .field.w-2 { min-width:160px; }
  .filters .field.w-3 { min-width:220px; }
  .filters .field.w-4 { min-width:280px; flex:1; }
  .filters .actions { display:flex; gap:10px; }
  .filters label { display:block; font-weight:600; color:#374151; margin-bottom:6px; }
  .filters input[type="text"], .filters input[type="date"], .filters select { 
    width:100%; height:40px; padding:8px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; color:#111827;
  }
  .filters input::placeholder { color:#9ca3af; }
  .filters input:focus, .filters select:focus { outline:none; border-color:#580706; box-shadow:0 0 0 3px rgba(88,7,6,.12); }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { padding:10px 12px; border-bottom:1px solid #f1f5f9; text-align:left; }
  .status { font-weight:700; padding:4px 8px; border-radius:999px; font-size:.8rem; }
  .status.sent { background:#fef3c7; color:#92400e; border:1px solid #f59e0b; }
  .status.partially_validated { background:#dbeafe; color:#1e3a8a; border:1px solid #60a5fa; }
  .status.validated { background:#dcfce7; color:#166534; border:1px solid #86efac; }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <div class="ribbon"><div class="marquee"><span>ECAGES • Journal d'approvisionnement (Commercial)</span></div></div>

  <div class="card" style="margin-bottom:16px;">
    <form method="get" class="filters">
      <div class="field w-4">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Recherche</label>
        <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Réf., facture…" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Statut</label>
        <select name="status">
        <option value="">Statut (tous)</option>
        <option value="draft" {% if status == 'draft' %}selected{% endif %}>Draft</option>
        <option value="sent" {% if status == 'sent' %}selected{% endif %}>Envoyée</option>
        <option value="partially_validated" {% if status == 'partially_validated' %}selected{% endif %}>Partielle</option>
        <option value="validated" {% if status == 'validated' %}selected{% endif %}>Validée</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Annulée</option>
        </select>
      </div>
      <div class="field w-3">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Fournisseur</label>
        <select name="provider">
        <option value="0">Fournisseur (tous)</option>
        {% for p in providers %}
        <option value="{{ p.id }}" {% if provider_id == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
        </select>
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Du</label>
        <input type="date" name="from" value="{{ date_from }}" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Au</label>
        <input type="date" name="to" value="{{ date_to }}" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Par page</label>
        <select name="per">
        <option value="25" {% if per == 25 %}selected{% endif %}>25/page</option>
        <option value="50" {% if per == 50 %}selected{% endif %}>50/page</option>
        <option value="100" {% if per == 100 %}selected{% endif %}>100/page</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn-primary" type="submit" style="height:40px;">Filtrer</button>
        <a href="{{ back_url }}" class="btn-secondary" style="height:40px; display:inline-flex; align-items:center;">Retour</a>
      </div>
    </form>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div style="display:flex; gap:16px; flex-wrap:wrap;">
      <div><strong>Total demandes:</strong> {{ totals.count|default:0 }}</div>
      <div><strong>Montant cumulé:</strong> {{ totals.total_amount|default:0|floatformat:0 }} FCFA</div>
    </div>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Référence</th>
          <th>Fournisseur</th>
          <th>Montant</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td>{{ r.reference }}</td>
          <td>{{ r.provider.name|default:'—' }}</td>
          <td>{{ r.total_amount|floatformat:0 }} FCFA</td>
          <td>
            <span class="status {{ r.status }}">
              {% if r.status == 'validated' %}Validée{% elif r.status == 'partially_validated' %}Partielle{% elif r.status == 'sent' %}Envoyée{% else %}{{ r.status|capfirst }}{% endif %}
            </span>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" style="text-align:center; padding:24px; color:#64748b;">Aucune demande trouvée</td></tr>
        {% endfor %}
      </tbody>
    </table>

    {% if page_obj.has_other_pages %}
    <div class="pagination" style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
      {% if page_obj.has_previous %}
        <a class="btn-secondary" href="?page=1">« Première</a>
        <a class="btn-secondary" href="?page={{ page_obj.previous_page_number }}">‹ Précédente</a>
      {% endif %}
      <span class="btn-secondary" style="background:#580706;color:#fff;border-color:#580706;">Page {{ page_obj.number }} / {{ paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn-secondary" href="?page={{ page_obj.next_page_number }}">Suivante ›</a>
        <a class="btn-secondary" href="?page={{ paginator.num_pages }}">Dernière »</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}


