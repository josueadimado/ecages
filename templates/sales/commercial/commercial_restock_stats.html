{% extends "layouts/base_sales.html" %}
{% block title %}Statistiques de ravitaillement{% endblock %}
{% block extra_css %}
<style>
  .card{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 8px 24px rgba(2,8,23,.06)}
  .btn{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:.7rem 1rem;font-weight:700;font-size:.96rem;display:inline-flex;align-items:center;gap:.45rem;line-height:1}
  .btn:hover{box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .btn-primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn-outline{background:#fff;color:#0f172a;border-color:var(--ring)}
  .btn-outline-brand{background:#fff;color:var(--brand);border-color:var(--brand)}
  .toolbar{padding:16px}
  /* Grid tuned to keep filters tidy and push actions to the right */
  .simple-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end;grid-auto-flow:row dense}
  .pills{display:inline-flex;flex-wrap:wrap;gap:.5rem;background:#fff;border:1px solid var(--ring);border-radius:999px;padding:.3rem}
  .pill{padding:.6rem 1.05rem;border-radius:999px;font-weight:800;color:#111827;display:inline-flex;align-items:center;gap:.4rem;cursor:pointer}
  .pill input{display:none}
  .pill.active{background:var(--brand);color:#fff}
  .field{display:flex;flex-direction:column;gap:8px}
  .field label{font-weight:900;color:#111827}
  .field select,.field input{height:56px;padding:0 14px;border:1px solid var(--ring);border-radius:12px;font-size:.98rem}
  /* Keep actions on the same row; align to bottom like other fields */
  .actions{display:flex;gap:12px;justify-content:flex-end;align-items:center;align-self:end}
  .actions .btn{min-width:160px;height:56px;display:inline-flex;align-items:center;justify-content:center}
  /* Widen search and actions on large screens so they don't collide */
  /* On desktop, use 12-column grid and explicit placements */
  @media (min-width: 1200px){
    .simple-grid{grid-template-columns:repeat(12,minmax(0,1fr))}
    /* Row 1 */
    .field.scope{grid-column:1 / span 3}
    .field.kind{grid-column:4 / span 3}
    .field.sp{grid-column:7 / span 2}
    .field.from{grid-column:9 / span 2}
    .field.to{grid-column:11 / span 2}
    /* Row 2 */
    .field.search{grid-column:1 / span 6}
    .actions{grid-column:7 / span 6}
  }
  .table-wrap{overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--ring);font-size:.82rem;color:#6b7280;text-align:left;padding:.8rem 1rem}
  tbody td{border-bottom:1px solid #edf2f7;padding:1rem}
  .num{font-variant-numeric: tabular-nums; font-family: ui-monospace, Menlo, monospace; text-align:right}
  .pager{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px}
  .pager .controls a,.pager .controls span{border:1px solid var(--ring);border-radius:10px;padding:.5rem .75rem;text-decoration:none;font-weight:800;color:#111827}
  .pager .controls .current{background:var(--brand);color:#fff;border-color:var(--brand)}
</style>
{% endblock %}

{% block content %}
<div class="page">
  <div class="ribbon"><div class="marquee"><span>ECAGES • Statistiques de ravitaillement</span></div></div>

  <div class="card toolbar" style="margin-bottom:16px;">
    <form method="get">
      <div class="simple-grid">
        <!-- Portée -->
        <div class="field scope">
          <label>Portée</label>
          <div class="pills">
            <label class="pill {% if scope == 'salespoint' %}active{% endif %}"><input type="radio" name="scope" value="salespoint" {% if scope == 'salespoint' %}checked{% endif %}/> Agences</label>
            <label class="pill {% if scope == 'warehouse' %}active{% endif %}"><input type="radio" name="scope" value="warehouse" {% if scope == 'warehouse' %}checked{% endif %}/> Entrepôt (CD)</label>
          </div>
        </div>
        <!-- Type -->
        <div class="field kind">
          <label>Type</label>
          <div class="pills">
            <label class="pill {% if type == 'all' %}active{% endif %}"><input type="radio" name="type" value="all" {% if type == 'all' %}checked{% endif %}/> Tous</label>
            <label class="pill {% if type == 'piece' %}active{% endif %}"><input type="radio" name="type" value="piece" {% if type == 'piece' %}checked{% endif %}/> Pièces</label>
            <label class="pill {% if type == 'moto' %}active{% endif %}"><input type="radio" name="type" value="moto" {% if type == 'moto' %}checked{% endif %}/> Motos</label>
          </div>
        </div>
        <!-- Agence -->
        <div class="field sp">
          <label>Agence / Entrepôt</label>
          <select name="sp">
            <option value="0">Tous</option>
            {% for sp in salespoints %}
            <option value="{{ sp.id }}" {% if sp_id == sp.id %}selected{% endif %}>{{ sp.name }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Dates -->
        <div class="field from">
          <label>Du</label>
          <input type="date" name="from" value="{{ date_from|default:'' }}" />
        </div>
        <div class="field to">
          <label>Au</label>
          <input type="date" name="to" value="{{ date_to|default:'' }}" />
        </div>
        <!-- Recherche -->
        <div class="field search">
          <label>Recherche</label>
          <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Produit ou marque…" />
        </div>
        <!-- Actions -->
        <div class="actions">
          <button class="btn btn-primary" type="submit">Afficher</button>
          <a class="btn btn-outline" href="?">Réinitialiser</a>
          <a class="btn btn-outline-brand" href="?scope={{ scope }}{% if sp_id %}&sp={{ sp_id }}{% endif %}{% if type %}&type={{ type }}{% endif %}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}{% if q %}&q={{ q }}{% endif %}&export=csv">Exporter CSV</a>
        </div>
      </div>
    </form>
  </div>

  {% if page_obj.has_other_pages %}
  <div class="pager">
    <div class="summary">Affichage {{ page_obj.start_index }}–{{ page_obj.end_index }} sur {{ paginator.count }}</div>
    <div class="controls">
      {% if page_obj.has_previous %}
        <a href="?page=1">«</a>
        <a href="?page={{ page_obj.previous_page_number }}">‹</a>
      {% else %}
        <span class="disabled">«</span>
        <span class="disabled">‹</span>
      {% endif %}
      <span class="current">Page {{ page_obj.number }} / {{ paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">›</a>
        <a href="?page={{ paginator.num_pages }}">»</a>
      {% else %}
        <span class="disabled">›</span>
        <span class="disabled">»</span>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Point de vente</th>
          <th>Produit</th>
          <th>Marque</th>
          <th class="num">Quantité</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.date|date:"Y-m-d H:i" }}</td>
          <td>{{ r.salespoint.name }}</td>
          <td>{{ r.product.name }}</td>
          <td>{{ r.brand }}</td>
          <td class="num">{{ r.qty }}</td>
          <td>{{ r.status }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align:center; padding:16px; color:#6b7280">Aucune donnée</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj.has_other_pages %}
  <div class="pager">
    <div class="summary">Affichage {{ page_obj.start_index }}–{{ page_obj.end_index }} sur {{ paginator.count }}</div>
    <div class="controls">
      {% if page_obj.has_previous %}
        <a href="?page=1">«</a>
        <a href="?page={{ page_obj.previous_page_number }}">‹</a>
      {% else %}
        <span class="disabled">«</span>
        <span class="disabled">‹</span>
      {% endif %}
      <span class="current">Page {{ page_obj.number }} / {{ paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">›</a>
        <a href="?page={{ paginator.num_pages }}">»</a>
      {% else %}
        <span class="disabled">›</span>
        <span class="disabled">»</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
