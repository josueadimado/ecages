{% extends "layouts/base_sales.html" %}
{% block title %}Imprimeur de codes-barres | ECAGES{% endblock %}
{% block extra_css %}
  <style>
    :root{ --ring:#e5e7eb; --muted:#64748b; }
    .page{ padding:16px; max-width:1200px; margin:0 auto; }
    .card{ background:#fff; border:1px solid var(--ring); border-radius:12px; box-shadow:0 8px 24px rgba(2,8,23,.06); margin-bottom:20px; }
    .header{ padding:24px; text-align:center; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border-radius:12px 12px 0 0; }
    .controls{ padding:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
    .search-input{ flex:1; min-width:200px; padding:10px 15px; border:2px solid var(--ring); border-radius:8px; font-size:16px; }
    .filter-select{ padding:10px 15px; border:2px solid var(--ring); border-radius:8px; font-size:16px; background:#fff; }
    .btn{ padding:10px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px; }
    .btn-primary{ background:#007bff; color:#fff; }
    .btn-primary:hover{ background:#0056b3; }
    .btn-success{ background:#28a745; color:#fff; }
    .btn-success:hover{ background:#1e7e34; }
    .btn-info{ background:#17a2b8; color:#fff; }
    .btn-info:hover{ background:#138496; }
    .barcode-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px; padding:20px; }
    .barcode-item{ background:#f8f9fa; border:1px solid var(--ring); border-radius:8px; padding:15px; text-align:center; }
    .barcode-image{ max-width:100%; height:auto; margin-bottom:10px; border:1px solid #ddd; }
    .barcode-info{ font-size:12px; color:var(--muted); margin-bottom:5px; }
    .barcode-name{ font-weight:bold; font-size:14px; color:#333; margin-bottom:8px; }
    .barcode-actions{ display:flex; gap:5px; justify-content:center; }
    .btn-small{ padding:5px 10px; font-size:12px; }
    .print-section{ background:#e8f5e8; padding:20px; border-radius:8px; margin:20px 0; }
    .stats{ display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px; }
    .stat-card{ background:#fff; padding:15px; border-radius:8px; text-align:center; border:1px solid var(--ring); }
    .stat-number{ font-size:24px; font-weight:bold; color:#007bff; }
    .stat-label{ font-size:12px; color:var(--muted); margin-top:5px; }
    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .no-results{ text-align:center; padding:40px; color:var(--muted); }
    @media print {
      .controls, .header, .btn { display:none !important; }
      .barcode-grid{ grid-template-columns:repeat(4, 1fr); gap:10px; }
      .barcode-item{ break-inside:avoid; page-break-inside:avoid; }
    }
  </style>
{% endblock %}
{% block content %}
<div class="page">
  <div class="card">
    <div class="header">
      <h1>üñ®Ô∏è Imprimeur de codes-barres</h1>
      <p>G√©n√©rez et imprimez les codes-barres pour vos produits</p>
    </div>
    
    <div class="controls">
      <input type="text" id="searchInput" class="search-input" placeholder="Rechercher un produit..." />
      <select id="typeFilter" class="filter-select">
        <option value="">Tous les types</option>
        <option value="prod">Produits</option>
        <option value="sp">Points de vente</option>
      </select>
      <button id="refreshBtn" class="btn btn-primary">üîÑ Actualiser</button>
      <button id="printAllBtn" class="btn btn-success">üñ®Ô∏è Imprimer tout</button>
      <button id="generateBtn" class="btn btn-info">‚ö° G√©n√©rer nouveaux</button>
    </div>
    
    <div class="stats" id="statsSection">
      <div class="stat-card">
        <div class="stat-number" id="totalBarcodes">-</div>
        <div class="stat-label">Codes-barres g√©n√©r√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="filteredCount">-</div>
        <div class="stat-label">R√©sultats filtr√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="selectedCount">0</div>
        <div class="stat-label">S√©lectionn√©s</div>
      </div>
    </div>
    
    <div class="print-section">
      <h3>üìã Instructions d'impression</h3>
      <ol>
        <li><strong>Format recommand√©:</strong> √âtiquettes 50x30mm ou 40x20mm</li>
        <li><strong>Qualit√©:</strong> Impression en haute r√©solution (300 DPI minimum)</li>
        <li><strong>Mat√©riel:</strong> Papier autocollant r√©sistant √† l'eau</li>
        <li><strong>Placement:</strong> Coller sur l'emballage du produit, visible et lisible</li>
        <li><strong>Test:</strong> V√©rifiez que le code peut √™tre scann√© avant de coller</li>
      </ol>
    </div>
  </div>
  
  <div class="card">
    <div class="barcode-grid" id="barcodeGrid">
      <div class="loading">Chargement des codes-barres...</div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  const searchInput = document.getElementById('searchInput');
  const typeFilter = document.getElementById('typeFilter');
  const refreshBtn = document.getElementById('refreshBtn');
  const printAllBtn = document.getElementById('printAllBtn');
  const generateBtn = document.getElementById('generateBtn');
  const barcodeGrid = document.getElementById('barcodeGrid');
  const totalBarcodes = document.getElementById('totalBarcodes');
  const filteredCount = document.getElementById('filteredCount');
  const selectedCount = document.getElementById('selectedCount');
  
  let allBarcodes = [];
  let filteredBarcodes = [];
  let selectedBarcodes = new Set();
  
  // Load barcodes from server
  async function loadBarcodes() {
    try {
      const response = await fetch('/inventory/api/barcode-list/');
      if (response.ok) {
        const data = await response.json();
        allBarcodes = data.barcodes || [];
        filterBarcodes();
      } else {
        // Fallback: try to load from static files
        loadBarcodesFromStatic();
      }
    } catch (error) {
      console.error('Error loading barcodes:', error);
      loadBarcodesFromStatic();
    }
  }
  
  // Fallback: load barcodes from static files (simulated)
  function loadBarcodesFromStatic() {
    // This would normally fetch from a directory listing API
    // For now, we'll show a message to generate barcodes first
    barcodeGrid.innerHTML = `
      <div class="no-results">
        <h3>üì¶ Aucun code-barres trouv√©</h3>
        <p>G√©n√©rez d'abord les codes-barres avec le bouton "G√©n√©rer nouveaux"</p>
        <p>Ou ex√©cutez: <code>python manage.py generate_barcodes</code></p>
      </div>
    `;
    totalBarcodes.textContent = '0';
    filteredCount.textContent = '0';
  }
  
  // Filter barcodes based on search and type
  function filterBarcodes() {
    const searchTerm = searchInput.value.toLowerCase();
    const typeFilterValue = typeFilter.value;
    
    filteredBarcodes = allBarcodes.filter(barcode => {
      const matchesSearch = !searchTerm || 
        barcode.name.toLowerCase().includes(searchTerm) ||
        barcode.filename.toLowerCase().includes(searchTerm);
      
      const matchesType = !typeFilterValue || 
        (typeFilterValue === 'prod' && barcode.filename.startsWith('prod_')) ||
        (typeFilterValue === 'sp' && barcode.filename.startsWith('sp_'));
      
      return matchesSearch && matchesType;
    });
    
    displayBarcodes();
    updateStats();
  }
  
  // Display barcodes in grid
  function displayBarcodes() {
    if (filteredBarcodes.length === 0) {
      barcodeGrid.innerHTML = `
        <div class="no-results">
          <h3>üîç Aucun r√©sultat trouv√©</h3>
          <p>Essayez de modifier vos crit√®res de recherche</p>
        </div>
      `;
      return;
    }
    
    barcodeGrid.innerHTML = filteredBarcodes.map(barcode => `
      <div class="barcode-item" data-filename="${barcode.filename}">
        <img src="/static/barcodes/${barcode.filename}" alt="${barcode.name}" class="barcode-image" />
        <div class="barcode-info">${barcode.filename}</div>
        <div class="barcode-name">${barcode.name}</div>
        <div class="barcode-actions">
          <button class="btn btn-primary btn-small" onclick="printBarcode('${barcode.filename}')">üñ®Ô∏è</button>
          <button class="btn btn-info btn-small" onclick="downloadBarcode('${barcode.filename}')">‚¨áÔ∏è</button>
          <button class="btn btn-success btn-small" onclick="toggleSelect('${barcode.filename}')">‚úì</button>
        </div>
      </div>
    `).join('');
  }
  
  // Update statistics
  function updateStats() {
    totalBarcodes.textContent = allBarcodes.length;
    filteredCount.textContent = filteredBarcodes.length;
    selectedCount.textContent = selectedBarcodes.size;
  }
  
  // Print single barcode
  function printBarcode(filename) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head><title>Imprimer ${filename}</title></head>
        <body style="margin:0; padding:20px; text-align:center;">
          <img src="/static/barcodes/${filename}" style="max-width:100%; height:auto;" />
          <p style="margin-top:10px; font-family:Arial; font-size:12px;">${filename}</p>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
  
  // Download single barcode
  function downloadBarcode(filename) {
    const link = document.createElement('a');
    link.href = `/static/barcodes/${filename}`;
    link.download = filename;
    link.click();
  }
  
  // Toggle selection
  function toggleSelect(filename) {
    if (selectedBarcodes.has(filename)) {
      selectedBarcodes.delete(filename);
    } else {
      selectedBarcodes.add(filename);
    }
    updateStats();
    updateSelectionUI();
  }
  
  // Update selection UI
  function updateSelectionUI() {
    document.querySelectorAll('.barcode-item').forEach(item => {
      const filename = item.dataset.filename;
      if (selectedBarcodes.has(filename)) {
        item.style.borderColor = '#28a745';
        item.style.backgroundColor = '#d4edda';
      } else {
        item.style.borderColor = '#e5e7eb';
        item.style.backgroundColor = '#f8f9fa';
      }
    });
  }
  
  // Print all selected barcodes
  function printSelected() {
    if (selectedBarcodes.size === 0) {
      alert('Veuillez s√©lectionner au moins un code-barres');
      return;
    }
    
    const printWindow = window.open('', '_blank');
    const selectedBarcodesArray = Array.from(selectedBarcodes);
    
    printWindow.document.write(`
      <html>
        <head>
          <title>Imprimer ${selectedBarcodesArray.length} codes-barres</title>
          <style>
            body { margin:0; padding:20px; }
            .barcode-page { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; margin-bottom:30px; }
            .barcode-item { text-align:center; border:1px solid #ddd; padding:10px; }
            .barcode-item img { max-width:100%; height:auto; }
            .barcode-item p { margin:5px 0; font-family:Arial; font-size:10px; }
            @media print { .barcode-page { page-break-after:always; } }
          </style>
        </head>
        <body>
          ${selectedBarcodesArray.map(filename => `
            <div class="barcode-item">
              <img src="/static/barcodes/${filename}" />
              <p>${filename}</p>
            </div>
          `).join('')}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
  
  // Generate new barcodes
  async function generateNewBarcodes() {
    if (confirm('Cela va g√©n√©rer de nouveaux codes-barres. Continuer?')) {
      try {
        const response = await fetch('/inventory/api/generate-barcodes/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
          }
        });
        
        if (response.ok) {
          alert('Codes-barres g√©n√©r√©s avec succ√®s!');
          loadBarcodes();
        } else {
          alert('Erreur lors de la g√©n√©ration des codes-barres');
        }
      } catch (error) {
        alert('Erreur de connexion');
      }
    }
  }
  
  // Event listeners
  searchInput.addEventListener('input', filterBarcodes);
  typeFilter.addEventListener('change', filterBarcodes);
  refreshBtn.addEventListener('click', loadBarcodes);
  printAllBtn.addEventListener('click', printSelected);
  generateBtn.addEventListener('click', generateNewBarcodes);
  
  // Load barcodes on page load
  loadBarcodes();
})();
</script>
{% endblock %}

