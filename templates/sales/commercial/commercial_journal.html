{% extends "layouts/base_sales.html" %}
{% block title %}Journal d'approvisionnement (Commercial){% endblock %}

{% block extra_css %}
<style>
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
  .filters { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
  .filters .field { display:flex; flex-direction:column; min-width:180px; }
  .filters .field.w-2 { min-width:160px; }
  .filters .field.w-3 { min-width:220px; }
  .filters .field.w-4 { min-width:220px; max-width:320px; flex:0 0 280px; }
  .filters .actions { display:flex; gap:10px; }
  .filters label { display:block; font-weight:600; color:#374151; margin-bottom:6px; }
  .filters input[type="text"], .filters input[type="date"], .filters select { 
    width:100%; height:40px; padding:8px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; color:#111827;
  }
  .filters input::placeholder { color:#9ca3af; }
  .filters input:focus, .filters select:focus { outline:none; border-color:#580706; box-shadow:0 0 0 3px rgba(88,7,6,.12); }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { padding:10px 12px; border-bottom:1px solid #f1f5f9; text-align:left; }
  .status { font-weight:700; padding:4px 8px; border-radius:999px; font-size:.8rem; }
  .status.sent { background:#fef3c7; color:#92400e; border:1px solid #f59e0b; }
  .status.partially_validated { background:#dbeafe; color:#1e3a8a; border:1px solid #60a5fa; }
  .status.validated { background:#dcfce7; color:#166534; border:1px solid #86efac; }
  /* Buttons */
  .btn { display:inline-flex; align-items:center; gap:8px; height:40px; padding:0 14px; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; border:1px solid #e5e7eb; }
  .btn-primary { background:#580706; color:#fff; border-color:#580706; }
  .btn-primary:hover { background:#460504; }
  .btn-secondary { background:#fff; color:#374151; }
  .btn-secondary:hover { background:#f3f4f6; }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <div class="ribbon"><div class="marquee"><span>ECAGES • Journal d'approvisionnement (Commercial)</span></div></div>

  <div class="card" style="margin-bottom:16px;">
    <form method="get" class="filters">
      <div class="field w-4">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Recherche</label>
        <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Réf., facture…" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Statut</label>
        <select name="status">
        <option value="">Statut (tous)</option>
        <option value="draft" {% if status == 'draft' %}selected{% endif %}>Draft</option>
        <option value="sent" {% if status == 'sent' %}selected{% endif %}>Envoyée</option>
        <option value="partially_validated" {% if status == 'partially_validated' %}selected{% endif %}>Partielle</option>
        <option value="validated" {% if status == 'validated' %}selected{% endif %}>Validée</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Annulée</option>
        </select>
      </div>
      <div class="field w-3">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Fournisseur</label>
        <select name="provider">
        <option value="0">Fournisseur (tous)</option>
        {% for p in providers %}
        <option value="{{ p.id }}" {% if provider_id == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
        </select>
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Du</label>
        <input type="date" name="from" value="{{ date_from }}" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Au</label>
        <input type="date" name="to" value="{{ date_to }}" />
      </div>
      <div class="field w-2">
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Par page</label>
        <select name="per">
        <option value="25" {% if per == 25 %}selected{% endif %}>25/page</option>
        <option value="50" {% if per == 50 %}selected{% endif %}>50/page</option>
        <option value="100" {% if per == 100 %}selected{% endif %}>100/page</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="submit" aria-label="Filtrer">
          <span>Filtrer</span>
        </button>
        <a href="{{ back_url }}" class="btn btn-secondary" aria-label="Retour">
          <span>Retour</span>
        </a>
      </div>
    </form>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div style="display:flex; gap:16px; flex-wrap:wrap;">
      <div><strong>Total demandes:</strong> {{ totals.count|default:0 }}</div>
      <div><strong>Montant cumulé:</strong> {{ totals.total_amount|default:0|floatformat:0 }} FCFA</div>
    </div>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Référence</th>
          <th>Fournisseur</th>
          <th>Montant</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td>{{ r.reference }}</td>
          <td>{{ r.provider.name|default:'—' }}</td>
          <td>{{ r.total_amount|floatformat:0 }} FCFA</td>
          <td>
            <span class="status {{ r.status }}">
              {% if r.status == 'validated' %}Validée{% elif r.status == 'partially_validated' %}Partielle{% elif r.status == 'sent' %}Envoyée{% else %}{{ r.status|capfirst }}{% endif %}
            </span>
          </td>
          <td>
            <button type="button" class="btn btn-secondary" onclick="cdOpenDetails({{ r.id }})">Voir détails</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align:center; padding:24px; color:#64748b;">Aucune demande trouvée</td></tr>
        {% endfor %}
      </tbody>
    </table>

    {% if page_obj.has_other_pages %}
    <div class="pagination" style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
      {% if page_obj.has_previous %}
        <a class="btn-secondary" href="?page=1">« Première</a>
        <a class="btn-secondary" href="?page={{ page_obj.previous_page_number }}">‹ Précédente</a>
      {% endif %}
      <span class="btn-secondary" style="background:#580706;color:#fff;border-color:#580706;">Page {{ page_obj.number }} / {{ paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn-secondary" href="?page={{ page_obj.next_page_number }}">Suivante ›</a>
        <a class="btn-secondary" href="?page={{ paginator.num_pages }}">Dernière »</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    if(document.getElementById('cdDetailsModal')) return;
    const modal = document.createElement('div');
    modal.id = 'cdDetailsModal';
    modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000;';
    modal.innerHTML = `
      <div style="max-width:960px; margin:4% auto; background:#fff; border-radius:12px; border:1px solid #e5e7eb; overflow:hidden;">
        <div style=\"display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #e5e7eb;\">
          <div style=\"font-weight:900;\">Détails d'approvisionnement</div>
          <button class=\"btn btn-secondary\" onclick=\"cdCloseDetails()\">Fermer</button>
        </div>
        <div style=\"padding:16px;\">
          <div id=\"cdDetailsInfo\" style=\"margin-bottom:10px; color:#374151; font-weight:600;\"></div>
          <div style=\"border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;\">
            <table style=\"width:100%; border-collapse:collapse;\">
              <thead style=\"background:#f8fafc;\">
                <tr>
                  <th style=\"text-align:left; padding:10px;\">Produit</th>
                  <th style=\"text-align:right; padding:10px;\">Qté</th>
                  <th style=\"text-align:center; padding:10px;\">Statut</th>
                </tr>
              </thead>
              <tbody id=\"cdDetailsLines\"></tbody>
            </table>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
  })();

  async function cdOpenDetails(reqId){
    const modal = document.getElementById('cdDetailsModal');
    const body = document.getElementById('cdDetailsLines');
    const info = document.getElementById('cdDetailsInfo');
    if(!modal || !body || !info){ return; }
    body.innerHTML = '<tr><td colspan="2" style="padding:16px; text-align:center; color:#64748b;">Chargement…</td></tr>';
    modal.style.display = 'block';
    try{
      const r = await fetch(`/inventory/api/wh/restock/${reqId}/lines/`);
      const data = await r.json();
      if(r.ok && data && Array.isArray(data.lines)){
        info.textContent = `Référence: ${data.reference} • Fournisseur: ${data.provider||'—'}`;
        body.innerHTML = '';
        data.lines.forEach(ln=>{
          const tr = document.createElement('tr');
          const badgeClass = ln.status === 'validated' ? 'background:#dcfce7;color:#166534;border:1px solid #86efac;' : 'background:#fef3c7;color:#92400e;border:1px solid #f59e0b;';
          const statusLabel = ln.status === 'validated' ? `Validé (${ln.qty_validated||ln.qty})` : 'En attente';
          tr.innerHTML = `<td style=\"padding:10px; border-bottom:1px solid #f1f5f9;\">${ln.product}</td>
                          <td style=\"padding:10px; text-align:right; border-bottom:1px solid #f1f5f9;\">${ln.qty}</td>
                          <td style=\"padding:10px; text-align:center; border-bottom:1px solid #f1f5f9;\"><span style=\"padding:4px 8px; border-radius:999px; font-weight:700; ${badgeClass}\">${statusLabel}</span></td>`;
          body.appendChild(tr);
        });
      }else{
        body.innerHTML = '<tr><td colspan="3" style="padding:16px; text-align:center; color:#64748b;">Aucune ligne.</td></tr>';
      }
    }catch(e){
      body.innerHTML = '<tr><td colspan="3" style="padding:16px; text-align:center; color:#b91c1c;">Erreur de chargement.</td></tr>';
    }
  }
  function cdCloseDetails(){ const m=document.getElementById('cdDetailsModal'); if(m) m.style.display='none'; }
</script>
{% endblock %}


